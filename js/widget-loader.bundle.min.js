"use strict";function codeAddress(a){var b=$.Deferred(),c=new google.maps.Geocoder;return c.geocode({address:a},function(a,c){if(c==google.maps.GeocoderStatus.OK){if(a[0]){var d=a[0].geometry.location;return b.resolve({latitude:d.lat(),longitude:d.lng()})}return b.reject("No results found")}return b.reject("Geocoder failed due to: "+c)}),b.promise()}function calcETA(a,b){var c=$.Deferred(),d={origin:a,destination:b,travelMode:google.maps.TravelMode.DRIVING},e=new google.maps.DirectionsService;return e.route(d,function(a,b){if(b==google.maps.DirectionsStatus.OK){var d=a.routes[0].legs[0].distance.text,e=a.routes[0].legs[0].duration.text;c.resolve({totalDistance:d,totalDuration:e})}}),c.promise()}L.Control.Locate=L.Control.extend({options:{position:"topleft",drawCircle:!0,follow:!1,stopFollowingOnDrag:!1,remainActive:!1,markerClass:L.circleMarker,circleStyle:{color:"#136AEC",fillColor:"#136AEC",fillOpacity:.15,weight:2,opacity:.5},markerStyle:{color:"#136AEC",fillColor:"#2A93EE",fillOpacity:.7,weight:2,opacity:.9,radius:5},followCircleStyle:{},followMarkerStyle:{},icon:"fa fa-map-marker",iconLoading:"fa fa-spinner fa-spin",circlePadding:[0,0],metric:!0,onLocationError:function(a){alert(a.message)},onLocationOutsideMapBounds:function(a){a.stopLocate(),alert(a.options.strings.outsideMapBoundsMsg)},setView:!0,keepCurrentZoomLevel:!1,showPopup:!0,strings:{title:"Show me where I am",popup:"You are within {distance} {unit} from this point",outsideMapBoundsMsg:"You seem located outside the boundaries of the map"},locateOptions:{maxZoom:1/0,watch:!0}},initialize:function(a){for(var b in a)"object"==typeof this.options[b]?L.extend(this.options[b],a[b]):this.options[b]=a[b]},onAdd:function(a){var b=L.DomUtil.create("div","leaflet-control-locate leaflet-bar leaflet-control"),c=this;this._layer=new L.LayerGroup,this._layer.addTo(a),this._event=void 0,this._locateOptions=this.options.locateOptions,L.extend(this._locateOptions,this.options.locateOptions),L.extend(this._locateOptions,{setView:!1});var d={};L.extend(d,this.options.markerStyle,this.options.followMarkerStyle),this.options.followMarkerStyle=d,d={},L.extend(d,this.options.circleStyle,this.options.followCircleStyle),this.options.followCircleStyle=d,this._link=L.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",b),this._link.href="#",this._link.title=this.options.strings.title,this._icon=L.DomUtil.create("span",this.options.icon,this._link),L.DomEvent.on(this._link,"click",L.DomEvent.stopPropagation).on(this._link,"click",L.DomEvent.preventDefault).on(this._link,"click",function(){var b=void 0===c._event||a.getBounds().contains(c._event.latlng)||!c.options.setView||i();!c.options.remainActive&&c._active&&b?n():e()}).on(this._link,"dblclick",L.DomEvent.stopPropagation);var e=function(){c.options.setView&&(c._locateOnNextLocationFound=!0),c._active||a.locate(c._locateOptions),c._active=!0,c.options.follow&&g(),c._event?j():l("requesting")},f=function(a){c._event&&c._event.latlng.lat===a.latlng.lat&&c._event.latlng.lng===a.latlng.lng&&c._event.accuracy===a.accuracy||c._active&&(c._event=a,c.options.follow&&c._following&&(c._locateOnNextLocationFound=!0),j())},g=function(){a.fire("startfollowing",c),c._following=!0,c.options.stopFollowingOnDrag&&a.on("dragstart",h)},h=function(){a.fire("stopfollowing",c),c._following=!1,c.options.stopFollowingOnDrag&&a.off("dragstart",h),k()},i=function(){return void 0===c._event?!1:a.options.maxBounds&&!a.options.maxBounds.contains(c._event.latlng)},j=function(){void 0===c._event.accuracy&&(c._event.accuracy=0);var b=c._event.accuracy;c._locateOnNextLocationFound&&(i()?c.options.onLocationOutsideMapBounds(c):a.fitBounds(c._event.bounds,{padding:c.options.circlePadding,maxZoom:c.options.keepCurrentZoomLevel?a.getZoom():c._locateOptions.maxZoom}),c._locateOnNextLocationFound=!1);var d,e;if(c.options.drawCircle)if(d=c._following?c.options.followCircleStyle:c.options.circleStyle,c._circle){c._circle.setLatLng(c._event.latlng).setRadius(b);for(e in d)c._circle.options[e]=d[e]}else c._circle=L.circle(c._event.latlng,b,d).addTo(c._layer);var f,g;c.options.metric?(f=b.toFixed(0),g="meters"):(f=(3.2808399*b).toFixed(0),g="feet");var h;if(h=c._following?c.options.followMarkerStyle:c.options.markerStyle,c._marker){c._marker.setLatLng(c._event.latlng);for(e in h)c._marker.options[e]=h[e]}else c._marker=c.options.markerClass(c._event.latlng,h).addTo(c._layer);var j=c.options.strings.popup;c.options.showPopup&&j&&c._marker.bindPopup(L.Util.template(j,{distance:f,unit:g}))._popup.setLatLng(c._event.latlng),k()},k=function(){c._container&&l(c._following?"following":"active")},l=function(a){"requesting"==a?(L.DomUtil.removeClasses(c._container,"active following"),L.DomUtil.addClasses(c._container,"requesting"),L.DomUtil.removeClasses(c._icon,c.options.icon),L.DomUtil.addClasses(c._icon,c.options.iconLoading)):"active"==a?(L.DomUtil.removeClasses(c._container,"requesting following"),L.DomUtil.addClasses(c._container,"active"),L.DomUtil.removeClasses(c._icon,c.options.iconLoading),L.DomUtil.addClasses(c._icon,c.options.icon)):"following"==a&&(L.DomUtil.removeClasses(c._container,"requesting"),L.DomUtil.addClasses(c._container,"active following"),L.DomUtil.removeClasses(c._icon,c.options.iconLoading),L.DomUtil.addClasses(c._icon,c.options.icon))},m=function(){c._active=!1,c._locateOnNextLocationFound=c.options.setView,c._following=!1};m();var n=function(){a.stopLocate(),a.off("dragstart",h),c.options.follow&&c._following&&h(),L.DomUtil.removeClass(c._container,"requesting"),L.DomUtil.removeClass(c._container,"active"),L.DomUtil.removeClass(c._container,"following"),m(),c._layer.clearLayers(),c._marker=void 0,c._circle=void 0},o=function(a){3==a.code&&c._locateOptions.watch||(n(),c.options.onLocationError(a))};return a.on("locationfound",f,c),a.on("locationerror",o,c),a.on("unload",n,c),this.locate=e,this.stopLocate=n,this.stopFollowing=h,b}}),L.Map.addInitHook(function(){this.options.locateControl&&(this.locateControl=L.control.locate(),this.addControl(this.locateControl))}),L.control.locate=function(a){return new L.Control.Locate(a)},function(){var a=function(a,b,c){c=c.split(" "),c.forEach(function(c){L.DomUtil[a].call(this,b,c)})};L.DomUtil.addClasses=function(b,c){a("addClass",b,c)},L.DomUtil.removeClasses=function(b,c){a("removeClass",b,c)}}();var _createClass=function(){function a(a,b){for(var c in b){var d=b[c];d.configurable=!0,d.value&&(d.writable=!0)}Object.defineProperties(a,b)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},MapilaryWidget=function(){function a(b){_classCallCheck(this,a),this._rooms=[],this._settings=$.extend({},this.constructor._defaults,b),this._$el=$(this._settings.el)}return _createClass(a,{render:{value:function(){var a=this,b=this._settings,c=this._$el,d=this._$el.clone();return d.empty(),d.addClass("mapilary-widget"),this._$el=d,b.trackForm&&d.append(this._renderTrackForm()),d.append(this.constructor._mapTpl),this._map=L.map(d.find(".map")[0]).setView(b.center,b.zoom),this._featureGroup=L.featureGroup(),L.tileLayer(b.tilesUrl,{attribution:b.attribution,maxZoom:b.maxZoom}).addTo(this._map),L.control.locate().addTo(this._map),this._featureGroup.addTo(this._map),b.trackingNr?void this.trackDelivery(b.trackingNr).done(function(){c.replaceWith(d),a.invalidateSize()}):(c.replaceWith(d),this.invalidateSize(),this)}},invalidateSize:{value:function(){var a=this._$el.height()-this._$el.find(".tracking-form").outerHeight(!0)-2;this._$el.find(".map-container").height(a),this._map.invalidateSize()}},_renderTrackForm:{value:function(){var a=this,b=$(this.constructor._trackFormTpl);return b.find("button:submit").on("click",function(b){b.preventDefault();var c=$(b.target.form[0]).val();a.trackDelivery(c)}),b}},_socketSubscribe:{value:function(a){var b=this,c=this._socket;return c?(this._rooms.push(a),c.emit("subscribe",a),c):(c=this._socket=io.connect(this._settings.wsUrl,{path:this._settings.wsPath}),c.on("connect",function(){b._rooms.push(a),c.emit("subscribe",a)}),c.on("error",function(a){console.error(a)}),c.on("position:update",function(a){var c=b.driver,d=a.coords,e=new L.LatLng(d.latitude,d.longitude);c?c.setLatLng(e):(c=b.driver=b._renderDriver(e),b._map.fitBounds(b._featureGroup,{padding:[15,15]}))}),c)}},_socketUnsubscribe:{value:function(){var a=this._socket;a&&this._rooms.length&&(this._rooms.forEach(function(b){a.emit("unsubscribe",b)}),this._rooms=[])}},trackDelivery:{value:function(a){var b=this;if(!a)return void alert("Please enter a tracking number to proceed");this._$el.find(".info-overlay").hide(),this._socketUnsubscribe(),this._featureGroup.clearLayers();var c=this._settings.deliveryServiceUrl.replace("{trackingNr}",a);$.get(c,function(c){if(!(c.addresses&&c.addresses.length>0))return void alert("Delivery has no drop address.");var d=c.addresses[0];return c.lastPosition&&c.lastPosition.coords&&(b.driver=b._renderDriver(c.lastPosition.coords),b._socketSubscribe("courier:"+c.lastPosition.courier)),d.coords?(c.coords=d.coords,b._socketSubscribe("trackingNr:"+a),void b._renderDelivery(c)):d.text?void codeAddress(d.text).done(function(d){c.coords=d,b._socketSubscribe("trackingNr:"+a),b._renderDelivery(c)}):void alert("Delivery has no drop address.")}).fail(function(){alert("Delivery not found")})}},_renderDriver:{value:function(a){var b=new L.LatLng(a.latitude,a.longitude),c=L.marker(b,{icon:L.icon({iconUrl:"images/driver-marker.png",iconSize:[40,54],iconAnchor:[20,54]})});return this._featureGroup.addLayer(c),c}},_renderDelivery:{value:function(a){var b=this._$el,c=a.coords,d=new L.LatLng(c.latitude,c.longitude);b.addClass("is-tracking");var e=L.marker(d,{icon:L.icon({iconUrl:"images/user-marker.png",iconSize:[40,54],iconAnchor:[20,54]})});this._featureGroup.addLayer(e),this._map.fitBounds(this._featureGroup,{padding:[30,30]});var f=b.find(".info-overlay");if(f.show(),a.etd)eta=new Date(a.etd.date),f.find(".eta .dynamic").html([eta.getHours(),eta.getMinutes()].join(":")),f.find(".client-position .dynamic").html(a.etd.orderNr);else{var g=[a.lastPosition.coords.latitude,a.lastPosition.coords.longitude].join(","),h=[a.coords.latitude,a.coords.longitude].join(",");calcETA(g,h).done(function(a){f.find(".eta .dynamic").html(a.totalDuration)})}f.find(".info").html(a.note)}}}),a}();MapilaryWidget._defaults={allowedTravelModes:"CAR",unitSystem:"METRIC",wsUrl:"https://ws.mapilary.com:443",wsPath:"/socket.io",deliveryServiceUrl:"https://api.mapilary.com/v1/deliveries/find/{trackingNr}",findPathUrl:"http://ec2-54-194-157-122.eu-west-1.compute.amazonaws.com/pathfinding/",tilesUrl:"https://{s}.tiles.mapbox.com/v3/mapilary.hmal3hg1/{z}/{x}/{y}.png",attribution:'&copy; <a href="http://www.mapbox.com">Mapbox</a>',center:[51.505,-.09],zoom:13,maxZoom:18,trackForm:!0},MapilaryWidget._trackFormTpl='<form class="tracking-form" class="form-inline" role="form"><div><div class="form-group"><input type="text" name="trackingNr" class="trackingNr form-control" title="for demonstration enter DEMO as Tracking Nr." placeholder="Tracking Nr." autofocus></div><button class="btn btn-default btn-track" data-toggle="collapse" data-target=".bs-widget-frame" type="submit">TRACK</button></div></form>',MapilaryWidget._mapTpl='<div class="map-container"><div class="info-overlay" style="display:none"><div class="eta"><b>ETA</b> <span class="dynamic"></span></div><div class="info"></div><div class="client-position"><div><span>#<b class="dynamic"></b></span></div><div class="text">Waiting list position</div></div></div><div class="map"></div></div>',"undefined"!=typeof module?module.exports=MapilaryWidget:window.MapilaryWidget=MapilaryWidget;